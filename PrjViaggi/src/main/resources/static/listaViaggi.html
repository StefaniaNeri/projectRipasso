<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
</head>

<body>
    <header>
        <nav class="navbar navbar-expand navbar-light bg-light">
            <ul class="nav navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="#" aria-current="page">Nav 1 <span
                            class="visually-hidden">(current)</span></a>
                </li>
                <!-- <li class="nav-item">
                    <a class="nav-link" href="#">Home</a>
                </li> -->
                <li class="nav-item">
                    <a class="nav-link" href="./pages/carrello.html">Carrello</a>
                </li>
                <div class=" ms-auto">

                    <li class="nav-item">
                        <button id="btnLogout" class="btn btn-danger">Logout</button>
                    </li>
                </div>
            </ul>
        </nav>

    </header>
    <main>

        <button id="btnUsers" class="btn btn-primary">Users</button>
        <button id="btnProds" class="btn btn-primary">Prodotti</button>

        <div class="container" id="cont1">
            <div class="row">
            </div>
        </div>

    </main>
    <footer>
        <!-- place footer here -->
    </footer>
    <!-- Bootstrap JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>

    <!-- SCRIPT NORMALE -->
    <script>
        let cont1 = document.querySelector("#cont1");
        let btnUsers = document.querySelector("#btnUsers");
        let rowCont1 = document.querySelector("#cont1 .row");

        const URL = "http://localhost:9003/api/utenti";

        function leggiUsers() {

            fetch(URL)
                .then(data => {
                    return data.json();
                })
                .then(response => {
                    rowCont1.innerHTML = "";
                    console.log(response);
                    response.forEach(user => {
                        rowCont1.innerHTML += creaCard(user);
                    });
                })
        }

        function creaCard(user) {
            let card = `
                    <div class="card col-4">
                        <div class="card-body">
                            <h3 class="card-title">${user.nome}</h3>
                            <p class="card-text">${user.email}</p>
                            
                        </div>
                    </div>
                `;
            return card;
        }


        btnUsers.addEventListener("click", leggiUsers);

        // LOGOUT
        let btnLogout = document.querySelector("#btnLogout");
        btnLogout.addEventListener("click", function () {

            localStorage.clear();
            window.location = "index.html";
        })


    </script>

    <!-- SCRIPT PRODOTTI -->
    <script>
        //Queste due variabili esistono già nello script.js
        // let cont1 = document.querySelector("#cont1");
        // let rowCont1 = document.querySelector("#cont1 .row");

        let ruoloUser = "";
        let nomeUser = "";

        function controllaUser() {
            // Legge nella local storage per vedere come è  fatto l'utente connesso
            let user = JSON.parse(localStorage.getItem("userConnesso"));

            if (user) {
                ruoloUser = user[0].role;
                nomeUser = user[0].nome;
            }
        }


        document.addEventListener("DOMContentLoaded", controllaUser);

        let btnProdcuts = document.querySelector("#btnProds");

        let URLviaggi = "http://localhost:9003/api/utenti";

        function caricaViaggi() {

            fetch(URLviaggi)
                .then(data => { return data.json() })
                .then(response => {
                    rowCont1.innerHTML = "";
                    response.forEach(viaggio => {
                        rowCont1.appendChild(creaCardProdotto(viaggio));
                    });
                })
        }

        btnProdcuts.addEventListener("click", caricaViaggi);

        function creaCardProdotto(prodotto) {
            let card = document.createElement("div");
            card.setAttribute("class", "card col-4 p-3 mb-2");

            let cardBody = document.createElement("div");
            cardBody.setAttribute("class", "card-body");


            cardBody.innerHTML = `<h3 class="card-title">${prodotto.name}</h3>
    <p class="card-text">${prodotto.price}</p>
    <img class="img img-fluid" src=${prodotto.avatar}>`;

            let btnCompra = document.createElement("button")
            btnCompra.setAttribute("class", "btn btn-success");
            btnCompra.textContent = "Buy";

            /**
             * Per poter utilizzare una funzione con un parametro devo obbligartoriamente utilizzare una funzione anonima
             */
            btnCompra.addEventListener("click", function () {
                acquista(prodotto)
            });


            card.appendChild(cardBody);
            card.appendChild(btnCompra);


            if (ruoloUser == "admin") {
                let btnDelProd = document.createElement("button");
                btnDelProd.textContent = "Elimina prodotto";
                btnDelProd.setAttribute("class", "btn btn-danger");

                card.appendChild(btnDelProd);
            }

            return card; //ATT: adesso la card è un HTMLObject
        }

        function acquista(prodotto) {
            console.log(prodotto);
            let endpoint = "/carrello";
            fetch(URL + endpoint, {
                method: "POST",
                headers: {
                    "Content-type": "application/json"
                },
                body: JSON.stringify(prodotto)
            })
                .then(data => { return data.json() })
        }
    </script>
</body>

</html>